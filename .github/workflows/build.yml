name: Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build:
    name: Build on ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Windows MSVC"
            os: windows-latest
            artifact: "windows-msvc"
            
          - name: "Ubuntu Linux"
            os: ubuntu-latest
            artifact: "linux"
            
          - name: "macOS"
            os: macos-latest
            artifact: "macos"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Windows: vcpkg
      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '8eb57355a4ffac410a25e60899fa6925a6f86a7b'
      
      # Linux: apt
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libarchive-dev \
            libxml2-dev \
            pkg-config \
            build-essential \
            zlib1g-dev \
            liblzma-dev
      
      # macOS: brew
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install libarchive pkg-config
      
      # Windows: CMake 설정
      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DBUILD_STATIC=ON `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static
        env:
          # vcpkg 바이너리 캐싱 비활성화
          VCPKG_BINARY_SOURCES: "clear"
      
      # Unix: CMake 설정
      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_STATIC=ON
      
      # 빌드
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel 4
      
      # 바이너리 위치 확인
      - name: List build output
        shell: bash
        run: |
          echo "Build directory contents:"
          if [ "$RUNNER_OS" == "Windows" ]; then
            ls -lh build/Release/ || true
          else
            ls -lh build/ || true
          fi
      
      # 아티팩트 업로드
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: workspace-controller-${{ matrix.config.artifact }}
          path: |
            build/Release/workspace-controller.exe
            build/workspace-controller
          if-no-files-found: warn
          retention-days: 90
